<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Recupere sua senha - Light Marketing">
    <title>Esqueci a Senha - Light Marketing</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="style.css?v=21.0">
    <link rel="stylesheet" href="css/auth.css?v=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <a href="login.html" class="back-button" title="Voltar para login">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Voltar
            </a>
            <div class="auth-header">
                <a href="login.html" class="auth-logo">
                    <img src="favicon.ico" alt="Light Marketing Logo" class="logo-icon" width="48" height="48">
                    <span class="logo-text"><span class="logo-light">LIGHT</span> <span class="logo-marketing">MARKETING</span></span>
                </a>
                <h1>Esqueceu a senha?</h1>
                <p>Digite seu e-mail para receber o link de recuperação</p>
            </div>

            <form id="forgot-password-form" class="auth-form">
                <div class="form-group">
                    <label for="email">E-mail</label>
                    <div class="input-wrapper">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 8L10.8906 13.2604C11.5624 13.7083 12.4376 13.7083 13.1094 13.2604L21 8M5 19H19C20.1046 19 21 18.1046 21 17V7C21 5.89543 20.1046 5 19 5H5C3.89543 5 3 5.89543 3 7V17C3 18.1046 3.89543 19 5 19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <input type="email" id="email" name="email" placeholder="seu@email.com" required autocomplete="email">
                    </div>
                </div>

                <div class="alert" id="alert" style="display: none;">
                    <span class="alert-message"></span>
                </div>

                <button type="submit" class="auth-btn" id="submit-btn">
                    <span class="btn-text">Enviar Link de Recuperação</span>
                    <span class="btn-loader" style="display: none;">
                        <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" stroke-dasharray="31.4 31.4" stroke-linecap="round">
                                <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
                            </circle>
                        </svg>
                    </span>
                </button>
            </form>

            <div class="auth-footer">
                <p>Lembrou a senha? <a href="login.html">Fazer login</a></p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js?v=1.0"></script>
    <script src="js/auth.js?v=1.0"></script>
    <script>
        let countdownInterval = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is already logged in
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                window.location.href = 'index.html';
                return;
            }

            // Handle forgot password form submission
            const form = document.getElementById('forgot-password-form');
            const submitBtn = document.getElementById('submit-btn');
            const alert = document.getElementById('alert');

            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value.trim();

                // Clear any existing countdown
                if (countdownInterval) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                }

                setLoading(submitBtn, true);
                hideAlert(alert);

                try {
                    // First check if email exists
                    const emailCheck = await checkEmailExists(email);
                    
                    if (!emailCheck.exists) {
                        showAlert(alert, 'Este e-mail não está cadastrado.', 'error');
                        setLoading(submitBtn, false);
                        return;
                    }

                    const result = await resetPassword(email);

                    if (result.success) {
                        showAlert(alert, 'E-mail de recuperação enviado! Verifique sua caixa de entrada.', 'success');
                        form.reset();
                    } else {
                        // Check if it's a cooldown error with countdown
                        if (result.cooldownSeconds) {
                            startCountdown(alert, result.cooldownSeconds);
                        } else {
                            showAlert(alert, result.error, 'error');
                        }
                    }
                } catch (error) {
                    console.error('Forgot password error:', error);
                    showAlert(alert, 'Erro ao verificar e-mail. Tente novamente.', 'error');
                }
                
                setLoading(submitBtn, false);
            });
        });

        function startCountdown(alertElement, seconds) {
            let remaining = seconds;
            
            // Show initial message
            updateCountdownMessage(alertElement, remaining, 'error');
            
            countdownInterval = setInterval(() => {
                remaining--;
                
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    showAlert(alertElement, 'Você já pode solicitar novamente.', 'success');
                } else {
                    updateCountdownMessage(alertElement, remaining, 'error');
                }
            }, 1000);
        }

        function updateCountdownMessage(alertElement, seconds, type) {
            alertElement.className = `alert ${type}`;
            alertElement.querySelector('.alert-message').textContent = 
                `Você só pode solicitar novamente para esse e-mail após ${seconds} segundo${seconds !== 1 ? 's' : ''}.`;
            alertElement.style.display = 'flex';
        }
    </script>
</body>
</html>
